# MinecraftServerController Plugin v1.3.9

Minecraft Server Control API と連携してゲーム内からサーバー管理を行うための Paper/Spigot プラグインです。

情報表示が起動時間じゃなくて日本時刻にする

## 🆕 v1.3.9 新機能

### 📊 プレイヤーアクティビティ統計
- **ログイン/ログアウト履歴**: すべてのプレイヤーの接続履歴を自動記録
- **総プレイ時間**: プレイヤーごとの累計プレイ時間を表示
- **セッション追跡**: 各セッションの詳細情報（時間、期間）
- **統計ダッシュボード**: 初回ログイン、最終ログイン、セッション数

### ⚡ サーバーパフォーマンスモニタリング
- **リアルタイムTPS表示**: 1分、5分、15分平均
- **メモリ使用率グラフ**: 視覚的なメモリ使用状況
- **エンティティ/チャンク追跡**: パフォーマンスに影響する要素を監視
- **自動警告**: TPS低下やメモリ不足を自動検知
- **履歴データ**: 過去1時間のパフォーマンス推移

### 🌍 ワールド管理
- **マルチワールド対応**: 複数ワールドの管理
- **ワールド読み込み/アンロード**: リソース管理の最適化
- **ワールド別バックアップ**: 個別ワールドのバックアップ作成
- **サイズ表示**: 各ワールドのディスク使用量
- **インポート/エクスポート**: ワールドの移動・共有

### 🎯 コマンドテンプレート
- **お気に入りコマンド**: よく使うコマンドを保存
- **プレースホルダー対応**: `{player}`, `{item}`, `{amount}` などの変数使用
- **コマンド履歴**: 最大50件の履歴を自動保存
- **デフォルトテンプレート**: 初回使用時に便利なテンプレートを自動作成

### 💬 チャットログビューア
- **全チャット記録**: すべてのチャットメッセージを記録
- **プレイヤー別フィルタ**: 特定プレイヤーの発言を抽出
- **キーワード検索**: 過去のメッセージを検索
- **統計情報**: 総メッセージ数、最もアクティブなプレイヤー
- **30日間保存**: 自動的に古いログを削除

## ✨ 既存機能

### 🎮 **GUI メニュー**
- `/msc` でインタラクティブなGUIメニューを開く
- ダッシュボード - サーバー全体を一目で把握
- コンソールGUI - よく使うコマンドのショートカット

### 💾 **バックアップ管理**
- バックアップの作成・一覧・リストア・削除
- 自動バックアップスケジュール管理GUI
- スケジュールの有効/無効切り替え
- 世代管理（古いバックアップの自動削除）

### 🔧 **サーバーコントロール**
- サーバーの起動・停止・ステータス確認
- 詳細なサーバーステータス表示
- メモリ使用率の視覚化（プログレスバー）

### 👥 **プレイヤー管理**
- ホワイトリスト管理（追加・削除・有効化/無効化）
- OP権限管理（付与・削除）
- オンラインプレイヤー一覧
- プレイヤー詳細情報（インベントリ閲覧、テレポート）

### 🔌 **プラグイン管理**
- プラグイン一覧表示
- プラグインリロード
- プラグインアップロード（.jar）
- プラグイン削除

### 📊 **モニタリング**
- メモリ使用状況
- サーバー情報
- リアルタイム通知システム
- パフォーマンスメトリクス

### 📝 **ログ・監査**
- サーバーログ閲覧
- 監査ログGUI（管理者専用）
- 操作履歴の視覚的な確認

### ⚙️ **設定管理**
- ゲーム内設定変更GUI
- デバッグモード切り替え
- 設定のリロード

## 📋 必要要件

- **Minecraft**: 1.20.4 (Paper推奨 / Spigot対応)
- **Java**: 17以上
- **API サーバー**: MinecraftServerController API が稼働していること

## 🚀 インストール

### ビルド方法

#### Gradle を使用（推奨 - Paper向け）:
```bash
# Linux/macOS
./gradlew clean build

# Windows
gradlew.bat clean build
```

#### 出力ファイル:
```
build/libs/MinecraftServerController-1.3.9.jar
```

### プラグインの配置

1. ビルド後のJARをサーバーの`plugins/`フォルダにコピー:
```bash
cp build/libs/MinecraftServerController-1.3.9.jar /path/to/server/plugins/
```

2. サーバーを起動または再起動

3. `plugins/MinecraftServerController/config.yml` を編集:
```yaml
api:
  url: "http://localhost:8000"      # APIサーバーのURL
  key: "your-api-key-here"          # APIキー

plugin:
  debug: false
  timeout: 30
```

4. プラグインをリロード:
```
/msc reload
```

## 🎮 コマンド一覧

### GUI コマンド
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc` | GUIメニューを開く | `msc.use` |
| `/msc gui` | GUIメニューを開く | `msc.use` |

### サーバー管理
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc status` | サーバーステータス表示 | `msc.server` |
| `/msc server start` | サーバー起動 | `msc.server.control` |
| `/msc server stop` | サーバー停止 | `msc.server.control` |
| `/msc metrics` | メトリクス表示 | `msc.server` |

### バックアップ管理
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc backup` | バックアップ作成 | `msc.backup` |
| `/msc backup list` | バックアップ一覧 | `msc.backup.list` |
| `/msc backup restore <file>` | バックアップをリストア | `msc.backup.restore` |
| `/msc backup delete <file>` | バックアップ削除 | `msc.backup.restore` |
| `/msc schedule list` | バックアップスケジュール表示 | `msc.admin` |
| `/msc schedule create` | スケジュール作成 | `msc.admin` |
| `/msc schedule toggle <id>` | スケジュール有効/無効 | `msc.admin` |
| `/msc schedule delete <id>` | スケジュール削除 | `msc.admin` |

### プレイヤー管理
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc players` | オンラインプレイヤー一覧 | `msc.players` |
| `/msc whitelist add <player>` | ホワイトリスト追加 | `msc.whitelist` |
| `/msc whitelist remove <player>` | ホワイトリスト削除 | `msc.whitelist` |
| `/msc whitelist list` | ホワイトリスト一覧 | `msc.whitelist` |
| `/msc whitelist on` | ホワイトリスト有効化 | `msc.whitelist` |
| `/msc whitelist off` | ホワイトリスト無効化 | `msc.whitelist` |
| `/msc op add <player>` | OP権限付与 | `msc.admin` |
| `/msc op remove <player>` | OP権限削除 | `msc.admin` |

### 🆕 パフォーマンスモニタリング
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc performance` | パフォーマンスGUI表示 | `msc.performance` |
| `/msc perf` | パフォーマンス情報表示 | `msc.performance` |

### 🆕 ワールド管理
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc world` | ワールド管理GUI | `msc.world` |
| `/msc world list` | ワールド一覧 | `msc.world` |
| `/msc world load <name>` | ワールドを読み込み | `msc.world` |
| `/msc world unload <name>` | ワールドをアンロード | `msc.world` |
| `/msc world backup <name>` | ワールドをバックアップ | `msc.world` |

### 🆕 チャットログ
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc chat` | チャットログGUI | `msc.chat` |
| `/msc chat search <keyword>` | キーワード検索 | `msc.chat` |
| `/msc chat player <name>` | プレイヤー別表示 | `msc.chat` |

### 🆕 コマンドテンプレート
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc template add <name> <cmd>` | テンプレート追加 | `msc.use` |
| `/msc template remove <name>` | テンプレート削除 | `msc.use` |
| `/msc template list` | テンプレート一覧 | `msc.use` |
| `/msc template use <name>` | テンプレート使用 | `msc.use` |

### 🆕 プレイヤー統計
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc stats` | 自分の統計表示 | `msc.use` |
| `/msc stats <player>` | 他プレイヤーの統計 | `msc.admin` |

### プラグイン管理
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc plugins list` | プラグイン一覧 | `msc.admin` |
| `/msc plugins reload` | プラグインリロード | `msc.admin` |

### ログ・監査
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc logs` | サーバーログ表示 | `msc.admin` |
| `/msc logs tail` | ログ末尾20行表示 | `msc.admin` |
| `/msc audit` | 監査ログ表示 | `msc.admin` |

### その他
| コマンド | 説明 | 権限 |
|---------|------|------|
| `/msc exec <command>` | コンソールコマンド実行 | `msc.exec` |
| `/msc reload` | プラグイン設定リロード | `msc.reload` |
| `/msc help` | ヘルプ表示 | `msc.use` |

## 🔐 権限一覧

| 権限 | 説明 | デフォルト |
|------|------|-----------|
| `msc.use` | 基本コマンド使用 | 全員 |
| `msc.backup` | バックアップ作成 | OP |
| `msc.backup.list` | バックアップ一覧表示 | OP |
| `msc.backup.restore` | バックアップリストア・削除 | OP |
| `msc.server` | サーバー情報閲覧 | 全員 |
| `msc.server.control` | サーバー起動・停止 | OP |
| `msc.players` | プレイヤー一覧閲覧 | 全員 |
| `msc.whitelist` | ホワイトリスト管理 | OP |
| `msc.exec` | コンソールコマンド実行 | OP |
| `msc.admin` | 管理者権限（OP・プラグイン・監査ログ） | OP |
| `msc.reload` | 設定リロード | OP |
| **🆕** `msc.world` | ワールド管理 | OP |
| **🆕** `msc.chat` | チャットログ閲覧 | OP |
| **🆕** `msc.performance` | パフォーマンス監視 | 全員 |

## 🎨 GUI機能

### メインメニュー (`/msc`)
- ★ ダッシュボード - サーバー全体の状況を一目で把握
- サーバーコントロール
- バックアップ管理
- プレイヤー管理
- プラグイン管理
- ★ コンソールコマンド - よく使うコマンドのショートカット
- **🆕 ★ パフォーマンスモニター** - TPS、メモリ、エンティティ
- **🆕 ★ ワールド管理** - 複数ワールドの管理
- **🆕 ★ チャットログビューア** - チャット履歴検索
- サーバーステータス
- メトリクス
- オンラインプレイヤー
- ログ表示
- ★ 監査ログ（管理者のみ）
- ★ バックアップスケジュール（管理者のみ）
- ★ 設定（管理者のみ）

### ダッシュボードGUI
- サーバーステータス（起動/停止）の視覚表示
- オンラインプレイヤー数と一覧
- メモリ使用率（視覚的なプログレスバー）
- 最新バックアップ情報
- アクティブなスケジュール数
- 各管理画面へのクイックアクセス
- リフレッシュボタン

### バックアップGUI
- 新規バックアップ作成
- バックアップ一覧表示
- バックアップリストア（左クリック）
- バックアップ削除（右クリック）
- スケジュール管理へのアクセス

### バックアップスケジュールGUI
- スケジュール一覧表示（有効/無効を色分け）
- 左クリック：有効/無効の切り替え
- 右クリック：スケジュール削除
- cron形式のヘルプ表示
- 最終実行時刻の確認

### 🆕 パフォーマンスモニターGUI
- **リアルタイムTPS**: 1分、5分、15分平均を色分け表示
- **メモリ使用率**: 視覚的なプログレスバーとパーセンテージ
- **エンティティ数**: 総数とプレイヤーあたりの数
- **ロード済みチャンク数**: 総数とプレイヤーあたりの数
- **プレイヤー数**: オンライン/最大人数
- **パフォーマンス履歴**: 過去1時間のTPSグラフ
- **自動警告**: TPS低下時の通知
- リフレッシュボタン

### 🆕 ワールド管理GUI
- **ワールド一覧**: 読み込み済み/未読み込みを色分け
- **ワールド情報**: サイズ、環境タイプ
- **左クリック**: ワールド読み込み/アンロード
- **右クリック**: スポーン地点へテレポート
- **Shift+クリック**: ワールドをバックアップ
- **統計情報**: 総ワールド数、読み込み数、合計サイズ
- リフレッシュボタン

### 🆕 チャットログビューアGUI
- **メッセージ一覧**: 最新30件のチャット表示
- **メッセージ詳細**: 日時、プレイヤー、ワールド、内容
- **統計情報**: 総メッセージ数、今日のメッセージ、最もアクティブなプレイヤー
- **検索機能**: コマンドからキーワード検索
- **プレイヤーフィルタ**: 特定プレイヤーの発言のみ表示
- リフレッシュボタン

### サーバーステータスGUI
- 詳細なサーバー状態表示
- コンテナ情報
- メモリ使用率（視覚的なバー + パーセンテージ）
- プレイヤー情報
- サーバーバージョン情報
- リフレッシュボタン

### サーバーコントロールGUI
- サーバー起動
- サーバー停止
- ステータス確認

### プラグインGUI
- インストール済みプラグイン一覧
- プラグインリロード

### コンソールGUI
- よく使うコマンドのショートカット
  - say Hello
  - time set day
  - weather clear
  - difficulty 切り替え
  - give コマンド
  - テレポートコマンド
- カスタムコマンド実行の案内

### 監査ログGUI（管理者専用）
- 操作履歴の一覧表示（最新30件）
- 日時、ユーザー、役割、アクション、詳細、IP
- アクションタイプに応じたアイコン表示
- 役割に応じた色分け（Root=赤、Admin=金、Player=緑）
- 統計情報（合計ログ数、役割別カウント）
- リフレッシュボタン

### 設定GUI（管理者専用）
- API URL 表示と変更方法の案内
- API Key 表示（マスク処理）と変更方法の案内
- デバッグモード切り替え（クリックで即時切り替え）
- タイムアウト設定の表示と変更方法
- 設定リロード
- 設定ファイルの場所表示
- デフォルト設定へのリセット案内
- 設定のバックアップ/リストア案内

## 🔔 通知システム

重要なイベント時に自動的にプレイヤーに通知します：

### 通知の種類
- **バックアップ通知**
  - バックアップ作成完了（管理者のみ）
  - バックアップリストア（全員）
  - バックアップ削除（管理者のみ）
  - スケジュールバックアップ実行（管理者のみ）

- **サーバー制御通知**
  - サーバー起動中（全員）
  - サーバー停止中（全員）
  - サーバー再起動中（全員）

- **プラグイン通知**
  - プラグインアップロード（管理者のみ）
  - プラグイン削除（管理者のみ）
  - プラグインリロード（管理者のみ）

- **ホワイトリスト/OP通知**
  - ホワイトリスト追加/削除（管理者のみ）
  - OP権限付与/削除（管理者のみ）

- **🆕 パフォーマンス警告**
  - TPS低下警告（管理者のみ）
  - 高メモリ使用率（管理者のみ）
  - 危険なメモリ使用率（全員）

- **警告通知**
  - エラー発生（管理者のみ）
  - 警告メッセージ（管理者のみ）

### 通知の特徴
- チャットメッセージと効果音で通知
- 役割に応じた通知の振り分け
- 色分けされた見やすいメッセージ
- 重要度に応じた効果音

## 📊 データベース管理（v1.3.9）

### 自動作成されるデータベース

プラグイン初回起動時に以下のデータベースファイルが自動作成されます：

```
plugins/MinecraftServerController/data/
├── activity.db      # プレイヤーアクティビティ
├── performance.db   # パフォーマンスメトリクス
└── chatlogs.db      # チャットログ
```

### データクリーンアップ

- **アクティビティログ**: 制限なし（全履歴保存）
- **パフォーマンスデータ**: 7日以上前のデータを自動削除
- **チャットログ**: 30日以上前のデータを自動削除

### バックアップ推奨

重要なデータは定期的にバックアップしてください：

```bash
# データディレクトリごとバックアップ
cp -r plugins/MinecraftServerController/data/ backups/msc-data-$(date +%Y%m%d)/
```

## 🔧 設定

### config.yml
```yaml
# API Settings
api:
  # API Base URL
  url: "http://localhost:8000"
  
  # API Key (get from API server)
  key: ""

# Plugin Settings
plugin:
  # Enable debug logging
  debug: false
  
  # Async request timeout (seconds)
  timeout: 30
```

### API キーの取得

1. **Web管理画面から取得**:
  - ブラウザで `http://localhost:8000` にアクセス
  - プレイヤー名を登録してAPIキーを取得
  - `config.yml` に設定

2. **ROOT_API_KEY を使用（開発環境向け）**:
  - API サーバーの環境変数 `ROOT_API_KEY` の値を使用
  - デフォルト: `super-secret-root-key`

## 📦 ビルド環境

### Gradle（推奨）
- Gradle 8.5+
- Java 17+
- Paper API 1.20.4
- **🆕** SQLite JDBC 3.44.1.0

## 🐛 トラブルシューティング

### "API Key is not set" エラー
→ `config.yml` の `api.key` を設定してください

### "Failed to fetch ..." エラー
→ API サーバーが起動しているか確認
→ `api.url` が正しいか確認
→ ファイアウォール設定を確認

### 権限エラー
→ OP権限: `/op YourPlayerName`
→ または権限プラグイン（LuckPerms等）で権限を付与

### GUIが開かない
→ サーバーが Paper/Spigot であることを確認
→ プラグインが正常にロードされているか確認: `/plugins`

### 🆕 データベースエラー

**症状**: "Failed to initialize database" エラー

**解決策**:
1. `plugins/MinecraftServerController/data/` ディレクトリの権限を確認
2. SQLite JDBC ドライバが正しく含まれているか確認
3. プラグインを再インストール

### 🆕 パフォーマンス警告が頻繁に表示される

**原因**: サーバーのTPS低下やメモリ不足

**解決策**:
1. `/msc performance` でパフォーマンスGUIを開く
2. エンティティ数、チャンク数を確認
3. 必要に応じてワールドをアンロード
4. 不要なエンティティを削除

### 🆕 チャットログが記録されない

**確認事項**:
1. ChatLogManager が正しく初期化されているか
2. `chatlogs.db` ファイルが存在するか
3. ログファイルでエラーを確認

### 通知が表示されない
→ NotificationManager が正しく初期化されているか確認
→ サーバーログでエラーを確認

## 🚀 開発

### ビルド
```bash
./gradlew clean build
```

### デバッグモード
`config.yml` で `plugin.debug: true` に設定

## 📄 ライセンス

MIT License

## 👤 作者

**woxloi**

## 🔗 関連リンク

- [Paper公式](https://papermc.io/)
- [Spigot公式](https://www.spigotmc.org/)
- [Gradle公式](https://gradle.org/)

---

**注意**: このプラグインを使用するには、MinecraftServerController API サーバーが稼働している必要があります。

## 🎯 おすすめの使い方

1. **まずはダッシュボードを開く** - `/msc` → ★ Dashboard
2. **サーバー状態を確認** - メモリ使用率、プレイヤー数など
3. **🆕 パフォーマンスを監視** - `/msc performance` でTPS、メモリをチェック
4. **バックアップスケジュールを設定** - 自動バックアップで安心
5. **🆕 ワールドを効率的に管理** - 不要なワールドをアンロードしてリソース節約
6. **🆕 チャットログで問題を追跡** - プレイヤー間のトラブルを迅速に解決
7. **🆕 コマンドテンプレートで効率化** - よく使うコマンドを保存
8. **監査ログで操作を確認** - セキュリティと透明性を確保
9. **通知を活用** - 重要なイベントを見逃さない

## 🆕 v1.3.9 の使い方

### パフォーマンス監視
```
/msc performance
→ リアルタイムでTPS、メモリ、エンティティ数を確認
→ 履歴グラフで過去の推移をチェック
```

### ワールド管理
```
/msc world list
→ すべてのワールドを一覧表示
→ GUIから簡単に読み込み/アンロード
```

### チャットログ検索
```
/msc chat search "hello"
→ "hello"を含むメッセージを検索
→ プレイヤー別の発言履歴も確認可能
```

### コマンドテンプレート
```
# テンプレート追加
/msc template add tp "tp {player} {x} {y} {z}"

# テンプレート使用
/msc template use tp
→ プレースホルダーの値を入力して実行
```

### プレイヤー統計
```
/msc stats
→ 自分の総プレイ時間、セッション数を確認
→ 最近のログイン履歴を表示
```

---

**🌟 v1.3.9の新機能を試してみてください！**